<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>

  <!--  Load Fancyapps via CDN : https://github.com/fancyapps/ui -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script> -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"/> -->
  <script src="js/fancybox.umd.js"></script>
  <link rel="stylesheet" href="styles/fancybox.css" />

  <!-- Load EXIF Reader (lecture des infos EXIF contenues dans la photo) -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script> -->
  <script src="js/lite.umd.js"></script>

  <!-- Load script utilitaires -->
  <script src="js/funct.js"></script>

  <!-- Load script d'affichage de la galerie -->
  <script src="js/loadImg.js"></script>

  <!-- Chargement de la police Google "Average" -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Average">

  <!-- Chargement des styles CSS -->
  <link rel="stylesheet" href="styles/styles.css" />

  <!-- Chargement des styles tooltips hint https://kushagra.dev/lab/hint/ -->
  <link rel="stylesheet" href="styles/hint.css" />

  <!-- Carte OpenStreetMap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

</head>

<body class="loading">
  <!-- TITRE -->
  <div id="hautdepage"></div>
  <div style="position: relative;">
    <!-- PHOTOS -->
    <div id="central"></div>
    <!-- % CHARGEMENT -->
    <div id="pourcent"></div>
  </div>
  <!-- RECHERCHE & LIENS -->
  <div id="menu">
    <p id="foundFiles" class="menu"><span id="resultat">Chargement des </span> photos</p>
  </div>
  <!-- INFOS IMAGE MOSAIQUE -->
  <div id="info-mosaic"></div>
  
  <!-- CONSOLE -->
  <p id="xmp-code"></p>

  <script>
    Fancybox.bind('[data-fancybox]', {
      Images: {
        initialSize: "fit",
      },
      Thumbs: {
        type: "modern",
      },
    });

    // Répertoire images
    const imageDir = './albums';
    // Titre
    const titreBandeau = 'Et in arcadia ego';
    // Page index
    const index = 'index.html';
    // Nombre de fichiers à  afficher
    const limit = 25;

    // Variables latitude et longitude de localisation
    var lat = new Array();
    var lon = new Array();

    // Affiche le titre
    document.getElementById('hautdepage').innerHTML = '<a href="' + index + '">' + titreBandeau + '</a>';


    /*********************************************************************/
    /* Affichage des répertoires
    /*********************************************************************/
    let albumList = '';
    const liste = new Map();

    // Liste le contenu du répertoire imageDir
    loadFiles(imageDir).then((listDir) => {
      parserDir = new DOMParser();
      xmlDocDir = parserDir.parseFromString(listDir, "text/html");
      // Liste du contenu des répertoire sous forme de HTMLcollection
      rep = xmlDocDir.getElementsByTagName("a");

      // Boucle pour créer la liste des répertoires
      for (i = 1; i < rep.length; i++) {
        // Supprime les espaces et le / dans le nom
        dirName = rep[i].childNodes[0].nodeValue.replace(/\//g, '');

        if (dirName.substring(0, 1) == ' ') {
          dirName = dirName.substring(1);
        }
        // Si le nom ne commence pas par un point, on l'enregistre
        if (dirName.substring(0, 1) != '.') {
          liste.set(dirName, dirName);
        }
      };

      // Répertoire par défaut (permier valeur de map)
      var getDir = liste.keys().next().value;

      /* Récupération paramètre GET dans l'URL
      */
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);

      /* data : Object contenant :
      /* le dossier d'image (dir)
      /* le champ de recherche (search)
      /* le choix du tri (numeric ou alphabetic)
      /* le type d'affichage (blog ou mosaic)
      **/
      let data = {
        dir: '',
        search: '',
        tri: 'numeric',
        typeAlbum: 'blog'
      };

      // Récupération paramètre URL 'dir'
      if(urlParams.get('dir')) {
        getDir = urlParams.get('dir');
        setCookie('dir', getDir, 3);
      } else if (getCookie('dir') && typeof getCookie('dir') !== 'undefined') {
        getDir = getCookie('dir');
      } 
      data.dir = imageDir + '/' + getDir;


      // Récupération paramètre URL 'tag'
      let tagUrl = urlParams.get('tag');
      // On remplace les espaces par _
      let search = tagUrl ? tagUrl.replaceAll(' ', '_') : 'all';

      // Récupération paramètre URL 'search'
      if (urlParams.get('search')) {
        // On remplace les , par des espaces
        search = urlParams.get('search').replaceAll(',', ' ');
        // On supprime les espaces doubles, ainsi que les espaces au début et en fin de recherche
        search = search.replace(/^\s+|\s+$|\s+(?=\s)/g, '');
      }
      data.search = search;

      // Récupération paramètre URL 'tri'
      if (typeof getCookie('tri') !== 'undefined') {
        let getTri = getCookie('tri');
        data.tri = getTri;
      }

      // Récupération paramètre URL style d'affichage ('blog' ou 'mosaic')
      if (urlParams.get('album')) {
        let typeAlbum = urlParams.get('album');
        setCookie('album', typeAlbum, 3);
        data.typeAlbum = typeAlbum;
      } else if (getCookie('album') && typeof getCookie('album') !== 'undefined') {
        let typeAlbum = getCookie('album');
        data.typeAlbum = typeAlbum;
      }

      /*********************************************************************/
      /* Selection des répertoires
      /*********************************************************************/
      // Affichage de la liste des répertoires photos dans albums
      liste.forEach((value, index) => {
        albumList += '<option value="' + index + '"';
        if (index == getDir) {
          albumList += ' selected="selected"';
        }
        albumList += '>' + value + '</option>';
      });

      // Formulaire de sélection du dossier images
      let dirForm = '<form action="index.html" method="get" onchange="this.submit()">';
      dirForm += '<img src="icons/dossier.png" class="icon" width="16" /> ';
      dirForm += '<select name="dir">' + albumList + '</select>';
      dirForm += '</form>';

      // Affichage menu déroulant des répertoires
      myDir = new Div();
      myDir.type = 'p';
      myDir.id = 'directory';
      myDir.container = 'foundFiles';
      myDir.contents = dirForm;
      myDir.classe = 'menu';
      myDir.position = 'before';
      myDir.show();

      /*********************************************************************/
      /* Création des liens de navigation de pages
      /*********************************************************************/

      // navLink : boutons de sélection d'affichage (tri par date ou nom et affichage en blog ou mosaique)
      // Icone devant les boutons de tri et d'affichage
      let navLink = '<img src="icons/photoset.png" class="icon" width=20" />&nbsp;';

      // Boutons de TRI
      // Paramètres globaux utilisés aussi dans la fonction 'tri'
      globalThis.numericButton = '<button class="hint--bottom" aria-label="Trier par date"  onclick="tri(\'central\', \'id\');"><img src="icons/sortnumericdown.png" class="icon" height="20" /></button>';
      globalThis.alphabeticButton = '<button class="hint--bottom" aria-label="Trier par nom" onclick="tri(\'central\', \'name\');"><img src="icons/sortalphabeticdown.png" class="icon" height="20" /></button>';
      let triButton = data.tri == 'numeric' ? globalThis.alphabeticButton : globalThis.numericButton;
      navLink += '<span id="boutontri">' + triButton + '</span>&nbsp;&nbsp;&nbsp;&nbsp';

      // Boutons mosaique ou blog
      globalThis.blogButton = '<button id="buttonBlog" class="hint--bottom" aria-label="Mode blog" onclick="toggleDisplay(\'blog\');"><img src="icons/icon-blog.png" class="icon" width="20" /></button>';
      globalThis.mosaicButton = '<button id="buttonMosaic" class="hint--bottom" aria-label="Mode mosaique" onclick="toggleDisplay(\'mosaic\');"><img src="icons/thumbnail-icon-18.jpg.png" class="icon" width="20" /></button>';
      let displayButton = data.typeAlbum == 'blog' ? globalThis.mosaicButton : globalThis.blogButton;
      navLink += '<span id="boutondisplay">' + displayButton + '</span>';

      // Formulaire de recherche
      navLink += '<form id="page" action="' + document.URL + '" method="GET">';
      // Renvoie le nom du dossier
      navLink += '</select><input type="text" value="' + getDir + '" name="dir" hidden="hidden" /><br />';
      // Renvoie les tags
      navLink += tagUrl ? '<input name="tag" value="' + tagUrl + '" hidden />' : '';
      // Renvoie la recherche
      navLink += search ? '<input name="search" value="' + search + '" hidden />' : '';
      navLink += '</form>';

      /*********************************************************************/
      /* Affichage liens de navigation
      /*********************************************************************/
      // Liens menu haut
      myLink = new Div();
      myLink.type = 'p';
      myLink.id = 'nav1';
      myLink.container = 'foundFiles';
      myLink.contents = navLink;
      myLink.classe = 'menu';
      myLink.position = 'before';
      myLink.show();

      /*********************************************************************/
      /* Formulaire du lien de recherche
      /*********************************************************************/
      let searchForm = '<form name="recherche" action="index.html" method="GET">';
      searchForm += '<img src="icons/search.png" class="icon" width="16" />';
      searchForm += '<input name="search" placeholder="recherche" value="" size="20" required />';
      searchForm += '<input type="text" value="' + getDir + '" name="dir" hidden="hidden" /> ';
      searchForm += '<input type="submit" value="OK" />';
      searchForm += '</form>';
      // Affichage liens de recherche
      myResult = new Div();
      myResult.type = 'p';
      myResult.id = 'search';
      myResult.container = 'foundFiles';
      myResult.contents = searchForm;
      myResult.classe = 'menu';
      myResult.position = 'before';
      myResult.show();

      /*********************************************************************/
      /* Affichage des tags de recherches
      /*********************************************************************/
      let searchText = '';
      if (search != 'all') {
        // Affichage des recherche avec lien de suppression
        searchArray = search.split(' ');
        searchArray.forEach((item) => {
          // Supprime le tag et recrée le search dans l'url sans le tag présent
          let newSearchArray = searchArray.filter((it) => it !== item)
          let newSearch = newSearchArray.join(' ');
          let searchUrl = newSearch !== '' ? newSearch : 'all';
          // Remplace les _ par un espace
          searchText = decode_utf8(item.replaceAll('_', ' '));
          mySearch = new Div();
          mySearch.type = 'span';
          mySearch.container = 'resultat';
          mySearch.contents = '<a href="' + index + '?search=' + searchUrl + '">&times; ' + searchText + '</a>';
          mySearch.classe = 'searchText';
          mySearch.position = 'before';
          mySearch.show();
        });
      }
      return data;
    }).then((data) => loadImg(data));
  </script>
</body>
</html>